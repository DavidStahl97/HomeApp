name: .NET Core

on:
  pull_request:
    branches: [ release ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - name: Setup .NET Core
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: 3.1.301
    
    - name: Install dependencies HomeCloud.Gateway
      run: dotnet restore HomeCloud.Gateway
    - name: Build HomeCloud.Gateway
      run: dotnet build HomeCloud.Gateway --configuration Release --no-restore
    
    - name: Install dependencies HomeCloud.Map/HomeCloud.Map.WebAPI/HomeCloud.Map.Presentation
      run: dotnet restore HomeCloud.Map/HomeCloud.Map.WebAPI/HomeCloud.Map.Presentation
    - name: Build HomeCloud.Map/HomeCloud.Map.WebAPI/HomeCloud.Map.Presentation
      run: dotnet build HomeCloud.Map/HomeCloud.Map.WebAPI/HomeCloud.Map.Presentation --configuration Release --no-restore

  docker:
    name: Publish - Docker Hub
    runs-on: ubuntu-latest
    needs: [test]
    env:
      REPO: ${{ secrets.DOCKER_REPO }}
    steps:
      - uses: actions/checkout@v2
      - name: Setup JDK 11
        uses: actions/setup-java@v1
        with:
          java-version: 11.0.4
      - name: Login to Docker Hub
        run: docker login -u ${{ secrets.DOCKER_USER }} -p ${{ secrets.DOCKER_PASS }}
      - name: Build Docker Compose
        run: docker-compose build
      - name: Publish Docker images
        run: docker-compose push
      - name: Logout
        run: docker logout  
        
  publish:
    name: Publish - Server
    runs-on: ubuntu-latest
    needs: [ docker ]
    steps:
      - name: executing remote docker pull
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.HOST_USERNAME }}
          password: ${{ secrets.HOST_PASSWORD }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            cd /
            cd homecloud
            curl --remote-name https://raw.githubusercontent.com/DavidStahl97/HomeCloud/master/docker-compose.yml   
            docker pull davidstahl97/homecloud-gateway
            docker pull davidstahl97/homecloud-map-webapi
            docker pull davidstahl97/homecloud-users-service
            docker-compose up -d
